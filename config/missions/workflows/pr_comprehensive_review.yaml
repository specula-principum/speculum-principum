id: pr_comprehensive_review
goal: |
  Conduct a comprehensive pull request review with safety validation:
  
  Phase 1: Initial Assessment (4-5 steps)
  - Fetch PR details and metadata
  - Review memory for similar PR reviews
  - Identify PR type (KB update, code change, config, docs)
  - Check for required review checklist completion
  - Assess initial risk level
  
  Phase 2: Content Analysis (6-8 steps)
  - Get full PR diff
  - Categorize changed files by type
  - Analyze additions vs deletions
  - Check for sensitive changes (security, config)
  - Verify no unauthorized scope expansion
  - Validate file paths are within expected areas
  - Check for merge conflicts
  
  Phase 3: Validation Workflows (5-7 steps)
  - If KB changes: run KB validation
  - If code changes: verify tests exist
  - If config changes: check against standards
  - Review commit messages for clarity
  - Verify branch naming conventions
  - Check for documentation updates if needed
  
  Phase 4: Safety and Policy Checks (4-6 steps)
  - Ensure no destructive changes without justification
  - Verify compliance with contribution guidelines
  - Check for proper approval requirements
  - Review security implications
  - Assess breaking change risk
  
  Phase 5: Decision and Action (5-7 steps)
  - Synthesize all analysis results
  - Generate confidence score for auto-approval
  - If confidence >= 0.8 and all checks pass: approve
  - If 0.5 <= confidence < 0.8: request changes with specifics
  - If confidence < 0.5: request human review
  - Post comprehensive review comment
  - Apply appropriate labels
  - If approved and safe, merge (with approval gate)
  
  The agent should use hierarchical planning for the review,
  adapt based on PR type, and leverage past review patterns
  to improve accuracy.

constraints:
  - Must complete all safety checks before approval
  - Cannot approve PRs with security implications
  - Cannot merge without explicit approval confirmation
  - Must provide detailed reasoning for all decisions
  - Should request guidance on ambiguous changes
  - Must record review outcomes for learning
  - Post interim findings every 8 steps

success_criteria:
  - All review phases completed
  - Safety checks passed or concerns documented
  - Review comment provides actionable feedback
  - Appropriate labels applied (approved, needs-changes, etc.)
  - High-confidence safe PRs auto-approved
  - Risky or unclear PRs escalated to humans
  - Review demonstrates pattern learning from past PRs
  - No false approvals (quality > speed)

max_steps: 35

allowed_tools:
  - get_pr_details
  - get_pr_diff
  - search_issues_by_label
  - add_label
  - remove_label
  - post_comment
  - approve_pr
  - merge_pr
  - validate_kb
  - request_human_guidance

requires_approval: true
