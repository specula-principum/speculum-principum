name: Knowledge Base Quality Check
permissions:
  contents: read
  issues: write

on:
  pull_request:
    paths:
      - 'knowledge-base/**'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate knowledge base changes
        id: validate
        continue-on-error: true
        run: |
          python -m main copilot kb-validate --kb-root knowledge-base --json > validation.json

      - name: Upload validation report
        if: always() && hashFiles('validation.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: kb-validation-report
          path: validation.json

      - name: Post validation summary
        if: always()
        id: summarize
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const core = require('@actions/core');
            const marker = '<!-- kb-quality-check -->';
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull request context; skipping comment.');
              return;
            }
            const reportPath = path.join(process.cwd(), 'validation.json');
            if (!fs.existsSync(reportPath)) {
              core.warning('validation.json not found; skipping comment.');
              return;
            }
            let data;
            try {
              data = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            } catch (error) {
              core.warning(`Unable to parse validation report: ${error}`);
              return;
            }
            const avgCompleteness = Number(data?.quality?.average_completeness ?? 0);
            const avgFindability = Number(data?.quality?.average_findability ?? 0);
            const belowThreshold = Array.isArray(data?.quality?.below_threshold) ? data.quality.below_threshold : [];
            const errors = Array.isArray(data?.errors) ? data.errors : [];
            const warnings = Array.isArray(data?.warnings) ? data.warnings : [];
            const lines = [
              marker,
              '## Knowledge Base Validation Summary',
              `- Documents checked: **${data.documents_checked ?? 0}**`,
              `- Documents valid: **${data.documents_valid ?? 0}**`,
              `- Average completeness: **${avgCompleteness.toFixed(2)}**`,
              `- Average findability: **${avgFindability.toFixed(2)}**`,
            ];
            if (belowThreshold.length) {
              lines.push('\n### Below Threshold');
              belowThreshold.slice(0, 10).forEach(item => lines.push(`- ${item}`));
              if (belowThreshold.length > 10) {
                lines.push(`- ...and ${belowThreshold.length - 10} more entries`);
              }
            }
            if (errors.length) {
              lines.push('\n### Errors');
              errors.slice(0, 10).forEach(message => lines.push(`- ${message}`));
              if (errors.length > 10) {
                lines.push(`- ...and ${errors.length - 10} more errors`);
              }
            }
            if (warnings.length) {
              lines.push('\n### Warnings');
              warnings.slice(0, 10).forEach(message => lines.push(`- ${message}`));
              if (warnings.length > 10) {
                lines.push(`- ...and ${warnings.length - 10} more warnings`);
              }
            }
            const commentBody = lines.join('\n');
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              per_page: 100,
            });
            const existing = comments.find(comment => comment.body && comment.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: commentBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: commentBody,
              });
            }
            core.setOutput('has-errors', errors.length ? 'true' : 'false');

      - name: Enforce validation status
        if: steps.validate.outcome == 'failure'
        run: exit 1
