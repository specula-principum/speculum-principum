name: "4. Auto-Merge: Sync PRs"

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-auto-merge:
    runs-on: ubuntu-latest
    # Only run on sync PRs from the upstream sync workflow
    if: startsWith(github.head_ref, 'sync/upstream-')
    
    steps:
      - name: Block forks
        if: github.event.repository.fork == true
        run: |
          echo "::error::Auto-merge is disabled for forked repositories"
          exit 1

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate PR file scope
        id: validate
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          python -m main validate-pr \
            --repo "${{ github.repository }}" \
            --pr ${{ github.event.pull_request.number }} \
            --json > /tmp/validation.json
          
          VALID=$(jq -r '.valid' /tmp/validation.json)
          REASON=$(jq -r '.reason' /tmp/validation.json)
          
          echo "valid=$VALID" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT
          
          if [ "$VALID" != "true" ]; then
            echo "âŒ PR validation failed: $REASON"
            exit 1
          fi
          
          echo "âœ… PR validation passed"

      - name: Verify PR branch and metadata
        id: verify
        run: |
          # Verify branch name pattern
          if [[ ! "${{ github.head_ref }}" =~ ^sync/upstream- ]]; then
            echo "::error::PR branch must match pattern sync/upstream-*"
            exit 1
          fi
          
          # Verify this is not a draft PR
          if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            echo "PR is a draft - skipping auto-merge"
            echo "auto_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if PR is from a fork
          if [ "${{ github.event.pull_request.head.repo.fork }}" == "true" ]; then
            echo "::error::PRs from forks cannot be auto-merged"
            exit 1
          fi
          
          echo "auto_merge=true" >> $GITHUB_OUTPUT
          echo "âœ… All verification checks passed"

      - name: Enable auto-merge
        if: steps.verify.outputs.auto_merge == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          python -m main enable-auto-merge \
            --repo "${{ github.repository }}" \
            --pr ${{ github.event.pull_request.number }} \
            --merge-method SQUASH

      - name: Approve PR
        if: steps.verify.outputs.auto_merge == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          python -m main approve-pr \
            --repo "${{ github.repository }}" \
            --pr ${{ github.event.pull_request.number }} \
            --body "âœ… Automated approval: Upstream sync PR passed all validation checks"

      - name: Create job summary
        if: always()
        run: |
          echo "## ðŸ”„ Sync PR Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.head_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate.outputs.valid }}" == "true" ]; then
            echo "### âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.verify.outputs.auto_merge }}" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ¤– Auto-merge enabled - PR will merge when checks pass" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
