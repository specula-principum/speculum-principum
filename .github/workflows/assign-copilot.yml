name: Assign Copilot Agent

on:
  issues:
    types:
      - labeled

permissions:
  issues: write

jobs:
  assign:
    if: github.event.label.name == 'ready-for-copilot'
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: ${{ github.repository }}
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      COPILOT_LABEL: ready-for-copilot
      COPILOT_BASE_BRANCH: ${{ vars.COPILOT_BASE_BRANCH }}
      COPILOT_EXTRA_INSTRUCTIONS: ${{ vars.COPILOT_EXTRA_INSTRUCTIONS }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install -r requirements.txt

      - name: Hand off issue to GitHub Copilot agent
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python - <<'PY'
          import os
          from src.integrations.github.assign_copilot import handoff_issue_to_copilot

          repo = os.environ["TARGET_REPO"]
          issue_number = int(os.environ["ISSUE_NUMBER"])
          token = os.environ["GH_TOKEN"]
          label = os.environ.get("COPILOT_LABEL", "ready-for-copilot")
          base_branch = os.environ.get("COPILOT_BASE_BRANCH") or None
          extra_instructions = os.environ.get("COPILOT_EXTRA_INSTRUCTIONS") or None

          result = handoff_issue_to_copilot(
              token=token,
              repository=repo,
              issue_number=issue_number,
              label=label,
              base_branch=base_branch,
              extra_instructions=extra_instructions,
          )

          print(f"Handed off issue #{result.issue_number} using branch '{result.branch_name}'.")
          if result.agent_output:
              print("Agent output:\n" + result.agent_output)
          print("Label removed:" , result.label_removed)
          PY
